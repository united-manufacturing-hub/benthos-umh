# Copyright 2025 UMH Systems GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  detect-changes:
    runs-on: depot-ubuntu-24.04
    permissions:
      contents: read
      pull-requests: read
    outputs:
      opcua: ${{ steps.filter.outputs.opcua }}
      modbus: ${{ steps.filter.outputs.modbus }}
      s7: ${{ steps.filter.outputs.s7 }}
      sparkplug: ${{ steps.filter.outputs.sparkplug }}
      eip: ${{ steps.filter.outputs.eip }}
      sensorconnect: ${{ steps.filter.outputs.sensorconnect }}
      tag_processor: ${{ steps.filter.outputs.tag_processor }}
      topic_browser: ${{ steps.filter.outputs.topic_browser }}
      uns: ${{ steps.filter.outputs.uns }}
      nodered_js: ${{ steps.filter.outputs.nodered_js }}
      stream_processor: ${{ steps.filter.outputs.stream_processor }}
      downsampler: ${{ steps.filter.outputs.downsampler }}
      classic_to_core: ${{ steps.filter.outputs.classic_to_core }}
      pkg: ${{ steps.filter.outputs.pkg }}
      cmd: ${{ steps.filter.outputs.cmd }}
      gomod: ${{ steps.filter.outputs.gomod }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Detect changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          initial-fetch-depth: 30
          filters: |
            opcua:
              - 'opcua_plugin/**'
              - '!opcua_plugin/**/*.md'
            modbus:
              - 'modbus_plugin/**'
              - '!modbus_plugin/**/*.md'
            s7:
              - 's7comm_plugin/**'
              - '!s7comm_plugin/**/*.md'
            sparkplug:
              - 'sparkplug_plugin/**'
              - '!sparkplug_plugin/**/*.md'
            eip:
              - 'eip_plugin/**'
              - '!eip_plugin/**/*.md'
            sensorconnect:
              - 'sensorconnect_plugin/**'
              - '!sensorconnect_plugin/**/*.md'
            tag_processor:
              - 'tag_processor_plugin/**'
              - '!tag_processor_plugin/**/*.md'
            topic_browser:
              - 'topic_browser_plugin/**'
              - '!topic_browser_plugin/**/*.md'
            uns:
              - 'uns_plugin/**'
              - '!uns_plugin/**/*.md'
            nodered_js:
              - 'nodered_js_plugin/**'
              - '!nodered_js_plugin/**/*.md'
            stream_processor:
              - 'stream_processor_plugin/**'
              - '!stream_processor_plugin/**/*.md'
            downsampler:
              - 'downsampler_plugin/**'
              - '!downsampler_plugin/**/*.md'
            classic_to_core:
              - 'classic_to_core_plugin/**'
              - '!classic_to_core_plugin/**/*.md'
            pkg:
              - 'pkg/**'
            cmd:
              - 'cmd/**'
            gomod:
              - 'go.{mod,sum}'
  license-eye:
    needs: detect-changes
    runs-on: depot-ubuntu-24.04
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install license-eye
        run: make install-license-eye
      - name: License Eye Header
        run: make license-check

  lint:
    needs: license-eye
    runs-on: depot-ubuntu-24.04-4
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Go
        uses: ./.github/actions/setup-go
      - name: Cache golangci-lint
        uses: actions/cache@v4
        with:
          path: ~/.cache/golangci-lint
          key: golangci-lint-${{ runner.os }}-${{ hashFiles('.golangci.yaml', 'go.sum') }}
          restore-keys: golangci-lint-${{ runner.os }}-
      - name: Lint
        run: make lint

  test-opcua:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.opcua == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true')
    uses: ./.github/workflows/test-opcua.yml
    secrets: inherit

  test-modbus:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.modbus == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true')
    uses: ./.github/workflows/test-modbus.yml
    secrets: inherit

  test-s7:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.s7 == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true')
    uses: ./.github/workflows/test-s7.yml
    secrets: inherit

  test-sparkplug:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.sparkplug == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true' ||
       needs.detect-changes.outputs.pkg == 'true')
    uses: ./.github/workflows/test-sparkplug.yml
    secrets: inherit

  test-eip:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.eip == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true')
    uses: ./.github/workflows/test-eip.yml
    secrets: inherit

  test-sensorconnect:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.sensorconnect == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true')
    uses: ./.github/workflows/test-sensorconnect.yml
    secrets: inherit

  test-tag-processor:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.tag_processor == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true' ||
       needs.detect-changes.outputs.pkg == 'true')
    uses: ./.github/workflows/test-tag-processor.yml
    secrets: inherit

  test-topic-browser:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.topic_browser == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true' ||
       needs.detect-changes.outputs.pkg == 'true')
    uses: ./.github/workflows/test-topic-browser.yml
    secrets: inherit

  test-uns:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.uns == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true' ||
       needs.detect-changes.outputs.pkg == 'true')
    uses: ./.github/workflows/test-uns.yml
    secrets: inherit

  test-nodered-js:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.nodered_js == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true')
    uses: ./.github/workflows/test-nodered-js.yml
    secrets: inherit

  test-stream-processor:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.stream_processor == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true')
    uses: ./.github/workflows/test-stream-processor.yml
    secrets: inherit

  test-downsampler:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.downsampler == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true')
    uses: ./.github/workflows/test-downsampler.yml
    secrets: inherit

  test-classic-to-core:
    needs: [detect-changes, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (needs.detect-changes.outputs.classic_to_core == 'true' ||
       needs.detect-changes.outputs.gomod == 'true' ||
       needs.detect-changes.outputs.cmd == 'true')
    uses: ./.github/workflows/test-classic-to-core.yml
    secrets: inherit

  result:
    name: Check Required Steps
    needs:
      - detect-changes
      - license-eye
      - lint
      - test-opcua
      - test-modbus
      - test-s7
      - test-sparkplug
      - test-eip
      - test-sensorconnect
      - test-tag-processor
      - test-topic-browser
      - test-uns
      - test-nodered-js
      - test-stream-processor
      - test-downsampler
      - test-classic-to-core
    if: always()
    runs-on: depot-ubuntu-24.04
    steps:
      - name: Check result
        run: |
          for result in \
            "${{ needs.detect-changes.result }}" \
            "${{ needs.license-eye.result }}" \
            "${{ needs.lint.result }}" \
            "${{ needs.test-opcua.result }}" \
            "${{ needs.test-modbus.result }}" \
            "${{ needs.test-s7.result }}" \
            "${{ needs.test-sparkplug.result }}" \
            "${{ needs.test-eip.result }}" \
            "${{ needs.test-sensorconnect.result }}" \
            "${{ needs.test-tag-processor.result }}" \
            "${{ needs.test-topic-browser.result }}" \
            "${{ needs.test-uns.result }}" \
            "${{ needs.test-nodered-js.result }}" \
            "${{ needs.test-stream-processor.result }}" \
            "${{ needs.test-downsampler.result }}" \
            "${{ needs.test-classic-to-core.result }}" \
          ; do
            if [[ "$result" == "failure" || "$result" == "cancelled" ]]; then
              echo "CI failed: job result was $result"
              exit 1
            fi
          done
          echo "CI passed (all jobs succeeded or were skipped)"
