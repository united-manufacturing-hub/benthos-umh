# Copyright 2023 UMH Systems GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: Benthos Schema Auto-Generation

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to generate (e.g., 0.11.6)'
        required: false
        type: string

concurrency:
  group: schema-gen-${{ github.ref }}
  cancel-in-progress: false

jobs:
  generate-and-update:
    runs-on:
      group: arc-runners-small
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout benthos-umh repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Extract version from release tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            # Extract version from release tag (e.g., refs/tags/v0.11.6 -> 0.11.6)
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          elif [ -n "${{ inputs.version }}" ]; then
            # Manual trigger with explicit version input
            VERSION="${{ inputs.version }}"
          else
            # Manual trigger - use latest tag
            VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//')
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.1'

      - name: Build schema exporter tool
        run: |
          go build -o schema-exporter ./cmd/schema-export
          chmod +x schema-exporter

      - name: Install dependencies
        run: |
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Generate versioned schema file
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ./schema-exporter -version "${VERSION}"

          # Verify schema file was created
          if [ ! -f "benthos-schemas-v${VERSION}.json" ]; then
            echo "ERROR: Schema file benthos-schemas-v${VERSION}.json was not generated"
            exit 1
          fi

          echo "Schema file generated: benthos-schemas-v${VERSION}.json"

          # Display basic stats
          INPUT_COUNT=$(jq '.inputs | length' "benthos-schemas-v${VERSION}.json")
          PROCESSOR_COUNT=$(jq '.processors | length' "benthos-schemas-v${VERSION}.json")
          OUTPUT_COUNT=$(jq '.outputs | length' "benthos-schemas-v${VERSION}.json")

          echo "INPUT_COUNT=${INPUT_COUNT}" >> $GITHUB_ENV
          echo "PROCESSOR_COUNT=${PROCESSOR_COUNT}" >> $GITHUB_ENV
          echo "OUTPUT_COUNT=${OUTPUT_COUNT}" >> $GITHUB_ENV

          echo "Schema contains: ${INPUT_COUNT} inputs, ${PROCESSOR_COUNT} processors, ${OUTPUT_COUNT} outputs"

      - name: Checkout ManagementConsole repository
        uses: actions/checkout@v4
        with:
          repository: united-manufacturing-hub/ManagementConsole
          token: ${{ secrets.CROSS_REPO_TOKEN }}
          path: ManagementConsole
          ref: main

      - name: Copy schema to ManagementConsole schemas folder
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          # Create schemas directory if it doesn't exist
          mkdir -p ManagementConsole/frontend/src/generated/schemas/

          # Copy versioned schema file
          cp "benthos-schemas-v${VERSION}.json" \
             "ManagementConsole/frontend/src/generated/schemas/benthos-schemas-v${VERSION}.json"

          echo "Schema copied to ManagementConsole/frontend/src/generated/schemas/benthos-schemas-v${VERSION}.json"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.CROSS_REPO_TOKEN }}
          path: ManagementConsole
          branch: auto/benthos-schemas-v${{ steps.version.outputs.VERSION }}
          commit-message: "chore: add benthos schemas v${{ steps.version.outputs.VERSION }}"
          title: "chore: add benthos schemas v${{ steps.version.outputs.VERSION }}"
          labels: |
            auto-generated
            dependencies
            ‚ö†Ô∏è requires-coordination
          body: |
            ## Auto-generated Benthos Schemas

            This PR adds benthos schemas version **${{ steps.version.outputs.VERSION }}** from the benthos-umh repository.

            ### ‚ö†Ô∏è MERGE COORDINATION REQUIRED

            **CRITICAL**: This PR must be merged BEFORE umh-core adopts benthos-umh v${{ steps.version.outputs.VERSION }}.

            **Merge sequence**:
            1. ‚úÖ Merge this PR to ManagementConsole (you are here)
            2. ‚úÖ Deploy ManagementConsole to production
            3. ‚úÖ Then merge umh-core PR upgrading to benthos-umh v${{ steps.version.outputs.VERSION }}

            **Failure to follow this sequence will cause**:
            - ManagementConsole validation errors (unknown schema version)
            - User-facing errors when creating/editing bridges
            - Rollback requirements

            ### Schema Statistics

            - **Inputs**: ${{ env.INPUT_COUNT }}
            - **Processors**: ${{ env.PROCESSOR_COUNT }}
            - **Outputs**: ${{ env.OUTPUT_COUNT }}

            ### Checklist

            - [ ] Verify schema file exists at `frontend/src/generated/schemas/benthos-schemas-v${{ steps.version.outputs.VERSION }}.json`
            - [ ] Confirm no manual edits needed (schemas are auto-generated)
            - [ ] Coordinate with umh-core team before merging
            - [ ] Deploy to production before umh-core upgrade

            ---

            *ü§ñ This PR was automatically generated by benthos-umh workflow*

            *Source: benthos-umh@${{ github.event.release.tag_name || github.ref }}*
