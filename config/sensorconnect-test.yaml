# Copyright 2025 UMH Systems GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

input:
  sensorconnect:
    device_address: "${TEST_DEBUG_IFM_ENDPOINT}"

pipeline:
  processors:
    - bloblang: |
          # these variables are autogenerated from your instance location
          let enterprise = "enterprise-of-kings"
          let site = "jeremy-vm"
          let area = "AL1350-2"
          let schema = "_historian"
          let invalid_payload = this.catch(true)
          if $invalid_payload == true { # this means it is not a json and instead a digital input
            let payload = {
              "timestamp_ms": (timestamp_unix_nano() / 1000000).floor(),
              "digital-input": content().string()
            }
          } else {
            let payload = this
            # add timestamp to the json
            payload."timestamp_ms" = (timestamp_unix_nano() / 1000000).floor()
            # put all metadata into the metadata object
            payload."metadata" = metadata()
          }
          # the rest from here here on will be autogenerated, see also documentation
          let tagname = meta("sensorconnect_port_number")

          root = {
            "payload": $payload,
            "metadata": metadata(),
            "tagname": $tagname,
          }
output:
  stdout: {}
